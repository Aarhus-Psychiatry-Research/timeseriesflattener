<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<meta property="og:title" content="Adding text features" />
<meta property="og:type" content="website" />
<meta property="og:url" content="tutorials/03_text.html" />
<meta property="og:site_name" content="timeseriesflattener" />
<meta property="og:description" content="So far, the tutorials have dealt with tabular data only. This tutorial will show you to make predictors out of text features, such as clinical notes, within timeseriesflattener. Specifically, this ..." />
<meta property="og:image:width" content="1146" />
<meta property="og:image:height" content="600" />
<meta property="og:image" content="/_images/social_previews/summary_tutorials_03_text_f323cf34.png" />
<meta property="og:image:alt" content="So far, the tutorials have dealt with tabular data only. This tutorial will show you to make predictors out of text features, such as clinical notes, within..." />
<meta name="description" content="So far, the tutorials have dealt with tabular data only. This tutorial will show you to make predictors out of text features, such as clinical notes, within timeseriesflattener. Specifically, this ..." />
<meta name="twitter:card" content="summary_large_image" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Frequently Asked Questions" href="../faq.html" /><link rel="prev" title="Advanced Tutorial" href="02_advanced.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 5.3.0 and Furo 2023.03.27 -->
        <title>Adding text features - Timeseriesflattener</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=fad236701ea90a88636c2a8c73b44ae642ed2a53" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #ff5454;
  --color-brand-content: #ff7575;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ff8f8f;
  --color-brand-content: #ff8f8f;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #ff8f8f;
  --color-brand-content: #ff8f8f;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Timeseriesflattener</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/icon.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/icon_dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Timeseriesflattener</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_basic.html">Introductory Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_advanced.html">Advanced Tutorial</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Adding text features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../feature_specifications.html">Feature specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timeseriesflattener.html">Timeseriesflattener</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Aarhus-Psychiatry-Research/timeseriesflattener/blob/main/CHANGELOG.md">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GitHub</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Aarhus-Psychiatry-Research/timeseriesflattener">GitHub Repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/Aarhus-Psychiatry-Research/timeseriesflattener/edit/main/docs/tutorials/03_text.ipynb" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="adding-text-features">
<h1>Adding text features<a class="headerlink" href="#adding-text-features" title="Permalink to this heading">#</a></h1>
<p>So far, the tutorials have dealt with <em>tabular</em> data only. This tutorial will show you to make predictors out of text features, such as clinical notes, within <code class="docutils literal notranslate"><span class="pre">timeseriesflattener</span></code>.</p>
<p>Specifically, this tutorial will cover <em>how to generate flattened predictors from already embedded text.</em></p>
<section id="the-dataset">
<h2>The dataset<a class="headerlink" href="#the-dataset" title="Permalink to this heading">#</a></h2>
<p>To start out, let’s load a synthetic dataset containing text. As with all other features, each row in the dataset needs an ID, a timestamp, and the feature value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">timeseriesflattener.testing.load_synth_data</span> <span class="kn">import</span> <span class="n">load_synth_text</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">synth_text</span> <span class="o">=</span> <span class="n">load_synth_text</span><span class="p">()</span>
<span class="n">synth_text</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entity_id</th>
      <th>timestamp</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4647</td>
      <td>1967-07-19 00:22:00</td>
      <td>The patient went into a medically induced coma...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007</td>
      <td>1966-11-25 02:02:00</td>
      <td>The patient is taken to the emergency departme...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5799</td>
      <td>1967-09-19 12:31:00</td>
      <td>The patient, described as a 7-month old son wh...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1319</td>
      <td>1969-07-21 23:16:00</td>
      <td>The patient had been left on a bed for 20 minu...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4234</td>
      <td>1966-04-14 22:04:00</td>
      <td>The patient had had some severe allergies but ...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="generating-predictors-from-embedded-text">
<h2>Generating predictors from embedded text<a class="headerlink" href="#generating-predictors-from-embedded-text" title="Permalink to this heading">#</a></h2>
<p>As generating text embeddings can often take a while, it can be an advantageous to embed the text before using <code class="docutils literal notranslate"><span class="pre">timeseriesflattener</span></code> to speed up the computation if you’re generating multiple datasets. This first block will show how to convert a dataframe with embeddings into a format that can be passed to <code class="docutils literal notranslate"><span class="pre">timeseriesflattener</span></code>.</p>
<p>To start, let’s embed the synthetic text data using TF-IDF. You can use any form of text-embedding you want - the only constraint is that the result of the embedding function should be a dataframe with an <code class="docutils literal notranslate"><span class="pre">entitiy_id_col</span></code>, <code class="docutils literal notranslate"><span class="pre">timestamp_col</span></code> and any number of <code class="docutils literal notranslate"><span class="pre">value_cols</span></code>.</p>
<p>For purposes of demonstration, we will fit a small TF-IDF model to the data and use it to embed the text.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>


<span class="c1"># define function to embed text and return a dataframe</span>
<span class="k">def</span> <span class="nf">embed_text_to_df</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">tfidf_model</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">tfidf_model</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">tfidf_model</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">())</span>


<span class="c1"># embed text</span>
<span class="n">embedded_text</span> <span class="o">=</span> <span class="n">embed_text_to_df</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">synth_text</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="c1"># drop the text column from the original dataframe</span>
<span class="n">metadata_only</span> <span class="o">=</span> <span class="n">synth_text</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="c1"># concatenate the metadata and the embedded text</span>
<span class="n">embedded_text_with_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metadata_only</span><span class="p">,</span> <span class="n">embedded_text</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">embedded_text_with_metadata</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entity_id</th>
      <th>timestamp</th>
      <th>and</th>
      <th>for</th>
      <th>in</th>
      <th>of</th>
      <th>or</th>
      <th>patient</th>
      <th>that</th>
      <th>the</th>
      <th>to</th>
      <th>was</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4647</td>
      <td>1967-07-19 00:22:00</td>
      <td>0.175872</td>
      <td>0.182066</td>
      <td>0.249848</td>
      <td>0.158430</td>
      <td>0.000000</td>
      <td>0.023042</td>
      <td>0.311389</td>
      <td>0.529966</td>
      <td>0.490203</td>
      <td>0.479312</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007</td>
      <td>1966-11-25 02:02:00</td>
      <td>0.244870</td>
      <td>0.000000</td>
      <td>0.135282</td>
      <td>0.064337</td>
      <td>0.465084</td>
      <td>0.336859</td>
      <td>0.151743</td>
      <td>0.729861</td>
      <td>0.179161</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5799</td>
      <td>1967-09-19 12:31:00</td>
      <td>0.192367</td>
      <td>0.232332</td>
      <td>0.283402</td>
      <td>0.336952</td>
      <td>0.000000</td>
      <td>0.176422</td>
      <td>0.238416</td>
      <td>0.646879</td>
      <td>0.250217</td>
      <td>0.382277</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1319</td>
      <td>1969-07-21 23:16:00</td>
      <td>0.165635</td>
      <td>0.200046</td>
      <td>0.183015</td>
      <td>0.261115</td>
      <td>0.125837</td>
      <td>0.151906</td>
      <td>0.205285</td>
      <td>0.759528</td>
      <td>0.403961</td>
      <td>0.098747</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4234</td>
      <td>1966-04-14 22:04:00</td>
      <td>0.493461</td>
      <td>0.119196</td>
      <td>0.272619</td>
      <td>0.207444</td>
      <td>0.000000</td>
      <td>0.045256</td>
      <td>0.183475</td>
      <td>0.588324</td>
      <td>0.433253</td>
      <td>0.235349</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now that we have our embeddings, we can use the <code class="docutils literal notranslate"><span class="pre">df_with_multiple_values_to_named_dataframes</span></code> function to turn the embeddings into a format that can be readily supplied to <code class="docutils literal notranslate"><span class="pre">PredictorGroupSpec</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">timeseriesflattener.df_transforms</span> <span class="kn">import</span> <span class="n">df_with_multiple_values_to_named_dataframes</span>

<span class="c1"># split the dataframe into a list of named dataframes with one value each</span>
<span class="n">embedded_dfs</span> <span class="o">=</span> <span class="n">df_with_multiple_values_to_named_dataframes</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">embedded_text_with_metadata</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
    <span class="n">entity_id_col_name</span><span class="o">=</span><span class="s2">&quot;entity_id&quot;</span><span class="p">,</span>
    <span class="n">timestamp_col_name</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
    <span class="n">name_prefix</span><span class="o">=</span><span class="s2">&quot;tfidf_&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># check the first dataframe</span>
<span class="n">embedded_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entity_id</th>
      <th>timestamp</th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4647</td>
      <td>1967-07-19 00:22:00</td>
      <td>0.175872</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2007</td>
      <td>1966-11-25 02:02:00</td>
      <td>0.244870</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5799</td>
      <td>1967-09-19 12:31:00</td>
      <td>0.192367</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1319</td>
      <td>1969-07-21 23:16:00</td>
      <td>0.165635</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4234</td>
      <td>1966-04-14 22:04:00</td>
      <td>0.493461</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check the number of embeddings/dataframes</span>
<span class="nb">len</span><span class="p">(</span><span class="n">embedded_dfs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10
</pre></div>
</div>
</div>
</div>
<p>Each dataframe has been named according to <code class="docutils literal notranslate"><span class="pre">name_prefix</span></code> and the column name. This means, that if your column names are informative (e.g. if they correspond to specific words in a BOW model) they will be kept.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">embedded_dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;tfidf_and&#39;
</pre></div>
</div>
</div>
</div>
<p>Let’s make some features!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">timeseriesflattener.aggregation_fns</span> <span class="kn">import</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">timeseriesflattener.feature_specs.group_specs</span> <span class="kn">import</span> <span class="n">PredictorGroupSpec</span>

<span class="c1"># create a group spec for the embedded text that will take the mean of each embedding on the column axis</span>
<span class="c1"># for the last 365 and 730 days</span>
<span class="n">emb_spec_batch</span> <span class="o">=</span> <span class="n">PredictorGroupSpec</span><span class="p">(</span>
    <span class="n">named_dataframes</span><span class="o">=</span><span class="n">embedded_dfs</span><span class="p">,</span>
    <span class="n">lookbehind_days</span><span class="o">=</span><span class="p">[</span><span class="mi">365</span><span class="p">,</span> <span class="mi">730</span><span class="p">],</span>
    <span class="n">fallback</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
    <span class="n">aggregation_fns</span><span class="o">=</span><span class="p">[</span><span class="n">mean</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">create_combinations</span><span class="p">()</span>

<span class="c1"># print the number of features we will create</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">emb_spec_batch</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20
</pre></div>
</div>
</div>
</div>
<p>We are creating 10*2=20 features: 1 for each embedding for each lookbehind (365 and 730 days).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make features how you would normally</span>
<span class="kn">from</span> <span class="nn">timeseriesflattener</span> <span class="kn">import</span> <span class="n">TimeseriesFlattener</span>
<span class="kn">from</span> <span class="nn">timeseriesflattener.testing.load_synth_data</span> <span class="kn">import</span> <span class="n">load_synth_prediction_times</span>

<span class="n">ts_flattener</span> <span class="o">=</span> <span class="n">TimeseriesFlattener</span><span class="p">(</span>
    <span class="n">prediction_times_df</span><span class="o">=</span><span class="n">load_synth_prediction_times</span><span class="p">(),</span>
    <span class="n">entity_id_col_name</span><span class="o">=</span><span class="s2">&quot;entity_id&quot;</span><span class="p">,</span>
    <span class="n">timestamp_col_name</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
    <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">drop_pred_times_with_insufficient_look_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ts_flattener</span><span class="o">.</span><span class="n">add_spec</span><span class="p">(</span><span class="n">emb_spec_batch</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">ts_flattener</span><span class="o">.</span><span class="n">get_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-02-13 10:59:28 [INFO] There were unprocessed specs, computing...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-02-13 10:59:28 [INFO] Processing 20 temporal features in parallel with 1 workers. Chunksize is 20. If this is above 1, it may take some time for the progress bar to move, as processing is batched. However, this makes for much faster total performance.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/20 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  5%|▌         | 1/20 [00:00&lt;00:07,  2.47it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 20/20 [00:00&lt;00:00, 49.28it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-02-13 10:59:28 [INFO] Checking alignment of dataframes - this might take a little while (~2 minutes for 1.000 dataframes with 2.000.000 rows).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-02-13 10:59:28 [INFO] Starting concatenation. Will take some time on performant systems, e.g. 30s for 100 features and 2_000_000 prediction times. This is normal.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-02-13 10:59:29 [INFO] Concatenation took 0.029 seconds
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2024-02-13 10:59:29 [INFO] Merging with original df
</pre></div>
</div>
</div>
</div>
<p>Let’s check the output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># dropping na values (no embeddings within the lookbehind period) for the sake of this example</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>entity_id</th>
      <th>timestamp</th>
      <th>prediction_time_uuid</th>
      <th>pred_tfidf_or_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_was_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_and_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_the_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_the_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_for_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_to_within_730_days_mean_fallback_nan</th>
      <th>...</th>
      <th>pred_tfidf_to_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_for_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_or_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_that_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_of_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_in_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_and_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_was_within_365_days_mean_fallback_nan</th>
      <th>pred_tfidf_patient_within_730_days_mean_fallback_nan</th>
      <th>pred_tfidf_in_within_730_days_mean_fallback_nan</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1917</th>
      <td>4977</td>
      <td>1968-11-28 16:05:00</td>
      <td>4977-1968-11-28-16-05-00</td>
      <td>0.221549</td>
      <td>0.086927</td>
      <td>0.145809</td>
      <td>0.534890</td>
      <td>0.534890</td>
      <td>0.088050</td>
      <td>0.284485</td>
      <td>...</td>
      <td>0.284485</td>
      <td>0.088050</td>
      <td>0.221549</td>
      <td>0.090356</td>
      <td>0.536339</td>
      <td>0.483324</td>
      <td>0.145809</td>
      <td>0.086927</td>
      <td>0.133722</td>
      <td>0.483324</td>
    </tr>
    <tr>
      <th>2463</th>
      <td>6840</td>
      <td>1965-11-02 07:17:00</td>
      <td>6840-1965-11-02-07-17-00</td>
      <td>0.355142</td>
      <td>0.092896</td>
      <td>0.155821</td>
      <td>0.285810</td>
      <td>0.285810</td>
      <td>0.376386</td>
      <td>0.456030</td>
      <td>...</td>
      <td>0.456030</td>
      <td>0.376386</td>
      <td>0.355142</td>
      <td>0.096561</td>
      <td>0.573168</td>
      <td>0.258256</td>
      <td>0.155821</td>
      <td>0.092896</td>
      <td>0.071452</td>
      <td>0.258256</td>
    </tr>
    <tr>
      <th>2580</th>
      <td>18</td>
      <td>1968-08-26 15:19:00</td>
      <td>18-1968-08-26-15-19-00</td>
      <td>0.000000</td>
      <td>0.260680</td>
      <td>0.000000</td>
      <td>0.601521</td>
      <td>0.601521</td>
      <td>0.000000</td>
      <td>0.639848</td>
      <td>...</td>
      <td>0.639848</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.260680</td>
      <td>0.401014</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2741</th>
      <td>9832</td>
      <td>1969-06-03 04:36:00</td>
      <td>9832-1969-06-03-04-36-00</td>
      <td>0.128228</td>
      <td>0.335410</td>
      <td>0.225044</td>
      <td>0.825558</td>
      <td>0.825558</td>
      <td>0.101924</td>
      <td>0.164655</td>
      <td>...</td>
      <td>0.164655</td>
      <td>0.101924</td>
      <td>0.128228</td>
      <td>0.000000</td>
      <td>0.236513</td>
      <td>0.186493</td>
      <td>0.225044</td>
      <td>0.335410</td>
      <td>0.103195</td>
      <td>0.186493</td>
    </tr>
    <tr>
      <th>2931</th>
      <td>7281</td>
      <td>1967-06-05 00:41:00</td>
      <td>7281-1967-06-05-00-41-00</td>
      <td>0.385111</td>
      <td>0.388547</td>
      <td>0.289663</td>
      <td>0.464891</td>
      <td>0.464891</td>
      <td>0.043730</td>
      <td>0.211934</td>
      <td>...</td>
      <td>0.211934</td>
      <td>0.043730</td>
      <td>0.385111</td>
      <td>0.269251</td>
      <td>0.304425</td>
      <td>0.280049</td>
      <td>0.289663</td>
      <td>0.388547</td>
      <td>0.332065</td>
      <td>0.280049</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../faq.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Frequently Asked Questions</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="02_advanced.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Advanced Tutorial</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/Aarhus-Psychiatry-Research/timeseriesflattener" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Adding text features</a><ul>
<li><a class="reference internal" href="#the-dataset">The dataset</a></li>
<li><a class="reference internal" href="#generating-predictors-from-embedded-text">Generating predictors from embedded text</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/design-tabs.js"></script>
    </body>
</html>